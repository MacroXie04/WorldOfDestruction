<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ game.name }} - Game Room</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        /* Container adjustments */
        .container-fluid { padding: 20px; }
        /* Divide the screen into two halves with full viewport height and scroll if needed */
        .left-half, .right-half {
            height: 100vh;
            overflow-y: auto;
        }
        .left-half {
            border-right: 1px solid #ccc;
        }
        /* Section spacing */
        .section { margin-bottom: 20px; }
        /* Map container and styling for 2D map visualization */
        #map-container {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            background-color: #f8f9fa;
            margin-bottom: 20px;
        }
        #map-container h4 { margin-bottom: 15px; }
        .country-map { margin-bottom: 10px; }
        .country-name { font-weight: bold; margin-bottom: 5px; }
        .land-bar {
            height: 20px;
            background-color: #007bff;
            border-radius: 3px;
        }
        /* Tables */
        table th, table td {
            text-align: center;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <!-- Left Half: Map and Country Information -->
        <div class="col-md-6 left-half">
            <!-- 2D Map at the top -->
            <div id="map-container" class="section">
                <h4>Map</h4>
                <div id="map">
                    <!-- Dynamic 2D map will be generated here -->
                </div>
            </div>
            <!-- Country Information at the bottom -->
            <div id="country-info" class="section">
                <hr>
                <h4>Other Country Information</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Country Name</th>
                            <th>Money</th>
                            <th>Population</th>
                            <th>Growth Rate</th>
                            <th>Land</th>
                        </tr>
                    </thead>
                    <tbody id="other-countries">
                        <!-- Rows updated dynamically -->
                    </tbody>
                </table>
                <hr>
                <h4>My Country</h4>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Country Name</th>
                            <th>Money</th>
                            <th>Population</th>
                            <th>Growth Rate</th>
                            <th>Land</th>
                        </tr>
                    </thead>
                    <tbody id="my-country-info">
                        <!-- Rows updated dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Right Half: Game Info, Actions, End Turn, Shop & Inventory -->
        <div class="col-md-6 right-half">
            <!-- Game Info -->
            <div id="game-info" class="section">
                <h1>{{ game.name }}</h1>
                <h3>Current Round: <span id="current-round">{{ game.current_round }}</span></h3>
                <p>
                    Current Turn: <span id="active-country">{{ active_country.name }}</span>
                    <span id="my-turn-status" class="badge badge-info ml-3"></span>
                </p>
            </div>
            <hr>
            <!-- Latest Three Actions -->
            <div id="latest-actions" class="section">
                <h4>Latest Three Actions</h4>
                <ul class="list-group" id="action-log">
                    <!-- Action log entries updated dynamically -->
                </ul>
            </div>
            <hr>
            <!-- End Turn Button -->
            <div id="end-round" class="section">
                <button id="end-turn" class="btn btn-danger">End Turn</button>
            </div>
            <hr>
            <!-- Shop Section -->
            <div id="shop-section" class="section">
                <h4>Shop</h4>
                <p>Remaining purchases this round: <span id="purchase-count">{{ purchase_remaining }}</span></p>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Weapons</h5>
                        <ul class="list-group">
                            {% for weapon in shop_weapons %}
                                <li class="list-group-item">
                                    <strong>{{ weapon.name }}</strong><br>
                                    Price: {{ weapon.price }}<br>
                                    Population Damage: {{ weapon.population_damage }}<br>
                                    Land Damage: {{ weapon.land_damage }}<br>
                                    <button class="btn btn-sm btn-primary purchase-weapon mt-2" data-weapon-id="{{ weapon.id }}">Purchase</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Tools</h5>
                        <ul class="list-group">
                            {% for tool in shop_tools %}
                                <li class="list-group-item">
                                    <strong>{{ tool.name }}</strong><br>
                                    Price: {{ tool.price }}<br>
                                    Population Increase: {{ tool.population_increase }}<br>
                                    Land Increase: {{ tool.land_increase }}<br>
                                    <button class="btn btn-sm btn-primary purchase-tool mt-2" data-tool-id="{{ tool.id }}">Purchase</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
            <hr>
            <!-- Inventory Section -->
            <div id="inventory-section" class="section">
                <h4>Inventory</h4>
                <div class="row">
                    <div class="col-md-6">
                        <h5>Weapons</h5>
                        <ul class="list-group" id="inventory-weapons">
                            {% for weapon in my_country.weapons_inventory.all %}
                                <li class="list-group-item">
                                    <strong>{{ weapon.name }}</strong><br>
                                    <label class="mt-2">Select Target Country:
                                        <select class="form-control target-country-use mt-1" data-weapon-id="{{ weapon.id }}">
                                            {% for country in countries %}
                                                {% if country.id != my_country.id %}
                                                    <option value="{{ country.id }}">{{ country.name }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </label>
                                    <button class="btn btn-sm btn-success mt-2 use-weapon" data-weapon-id="{{ weapon.id }}">Use</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h5>Tools</h5>
                        <ul class="list-group" id="inventory-tools">
                            {% for tool in my_country.tools_inventory.all %}
                                <li class="list-group-item">
                                    <strong>{{ tool.name }}</strong>
                                    <button class="btn btn-sm btn-success mt-2 use-tool" data-tool-id="{{ tool.id }}">Use</button>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div><!-- End of Right Half -->
    </div>
</div>

<!-- jQuery and AJAX -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    // Global variables
    var myCountryId = {{ my_country.id }};
    var pollInterval = null;
    var lastAlerted = "";

    // Update the dynamic 2D map based on each country's land value
    function updateMap(countries) {
        var maxLand = 0;
        countries.forEach(function(country) {
            if (country.land > maxLand) {
                maxLand = country.land;
            }
        });
        var mapHTML = "";
        if (maxLand === 0) {
            mapHTML = "<div>No land data available.</div>";
        } else {
            countries.forEach(function(country) {
                var barWidth = (country.land / maxLand) * 100;
                mapHTML += "<div class='country-map'>";
                mapHTML += "<div class='country-name'>" + country.name + "</div>";
                mapHTML += "<div class='land-bar' style='width: " + barWidth + "%;'></div>";
                mapHTML += "</div>";
            });
        }
        $("#map").html(mapHTML);
    }

    // Update the country information tables on the left half
    function updateCountryInfo(countries) {
        var otherHTML = "";
        var myHTML = "";
        countries.forEach(function(country) {
            var row = "<tr>" +
                          "<td>" + country.name + "</td>" +
                          "<td>" + country.money + "</td>" +
                          "<td>" + country.population + "</td>" +
                          "<td>" + country.population_growth_rate + "</td>" +
                          "<td>" + country.land + "</td>" +
                      "</tr>";
            if (country.is_mine) {
                myHTML += row;
            } else {
                otherHTML += row;
            }
        });
        $("#other-countries").html(otherHTML);
        $("#my-country-info").html(myHTML);
    }

    // Update latest actions log
    function updateActionLog(actions) {
        var logHtml = "";
        if (actions && actions.length > 0) {
            actions.forEach(function(log) {
                logHtml += "<li class='list-group-item'>" + log.timestamp + " - " + log.action + "</li>";
                if (log.action.indexOf("attack") !== -1 && log.action.indexOf("{{ my_country.name|escapejs }}") !== -1) {
                    if (lastAlerted !== log.timestamp) {
                        alert("You are under attack: " + log.action);
                        lastAlerted = log.timestamp;
                    }
                }
            });
        } else {
            logHtml = "<li class='list-group-item'>No records</li>";
        }
        $("#action-log").html(logHtml);
    }

    // Update game state and refresh all dynamic sections
    function updateGameStatus() {
        $.getJSON("{% url 'api_game_status' game.id %}", function (data) {
            $("#current-round").text(data.current_round);
            $("#active-country").text(data.active_country.name);
            $("#purchase-count").text(data.purchase_remaining);
            updateActionLog(data.last_actions);
            updateMap(data.countries);
            updateCountryInfo(data.countries);

            if (data.active_country.id === myCountryId) {
                $("#my-turn-status").text("Your turn ✅").removeClass().addClass("badge badge-success ml-3");
                if (pollInterval) {
                    clearInterval(pollInterval);
                    pollInterval = null;
                }
            } else {
                $("#my-turn-status").text("Waiting for other players...").removeClass().addClass("badge badge-secondary ml-3");
                if (!pollInterval) {
                    pollInterval = setInterval(updateGameStatus, 1000);
                }
            }
        });
    }

    // Initial update and polling every second
    updateGameStatus();
    if (!pollInterval) {
        pollInterval = setInterval(updateGameStatus, 1000);
    }

    // Purchase Weapon (no target selection required)
    $(".purchase-weapon").click(function () {
        var weaponId = $(this).data("weapon-id");
        $.post("{% url 'purchase_item' game.id %}", {
            item_type: 'weapon',
            item_id: weaponId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (data) {
            alert(data.message);
            updateGameStatus();
            location.reload();
        });
    });

    // Purchase Tool
    $(".purchase-tool").click(function () {
        var toolId = $(this).data("tool-id");
        $.post("{% url 'purchase_item' game.id %}", {
            item_type: 'tool',
            item_id: toolId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (data) {
            alert(data.message);
            updateGameStatus();
            location.reload();
        });
    });

    // Use Weapon (with target country selection)
    $(".use-weapon").click(function () {
        var weaponId = $(this).data("weapon-id");
        var targetCountry = $(this).siblings("label").find("select").val();
        $.post("{% url 'use_item' game.id %}", {
            item_type: 'weapon',
            item_id: weaponId,
            target_country: targetCountry,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (data) {
            alert(data.message);
            updateGameStatus();
            location.reload();
        });
    });

    // Use Tool (no target needed)
    $(".use-tool").click(function () {
        var toolId = $(this).data("tool-id");
        $.post("{% url 'use_item' game.id %}", {
            item_type: 'tool',
            item_id: toolId,
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (data) {
            alert(data.message);
            updateGameStatus();
            location.reload();
        });
    });

    // End Turn
    $("#end-turn").click(function () {
        $.post("{% url 'end_turn' game.id %}", {
            csrfmiddlewaretoken: '{{ csrf_token }}'
        }, function (data) {
            alert(data.message);
            updateGameStatus();
            location.reload();
        });
    });
</script>
</body>
</html>
